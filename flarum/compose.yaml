services:
  cron:
    extends:
      file: ../common/compose.yaml
      service: common
    depends_on:
      - php-fpm
    build:
      dockerfile_inline: |
        # syntax=docker/dockerfile:1
        FROM php-fpm

        # https://stackoverflow.com/questions/37458287/how-to-run-a-cron-job-inside-a-docker-container
        RUN apt-get update && apt-get install -y cron && which cron && rm -rf /etc/cron.*/*
        COPY <<CRON /etc/crontab
          # https://stackoverflow.com/questions/2388087/how-to-get-cron-to-call-in-the-correct-paths
          PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          # https://gist.github.com/x-yuri/336fd3185de7e168023867302d5ac99b?permalink_comment_id=5282378#gistcomment-5282378
          # https://askubuntu.com/questions/307534/unable-to-su-with-root-bin-bash-permission-denied
          * * * * * root su www-data -s /bin/sh -c 'php -d disable_functions $WEB_ROOT/flarum schedule:run' >/proc/1/fd/1 2>/proc/1/fd/2
        CRON

        # https://github.com/AnalogJ/docker-cron/blob/90c46adeb33fd1ada42b4fb801b5b07642ee08b6/debian.dockerfile#L13
        CMD ["cron", "-f", "-L", "2"]
